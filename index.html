<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>MR Studio Diamond v4.0 (Pro Chroma + Geo Morph)</title>
  <script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
  <style>
    /* ESTILOS DE INTERFAZ (UI LIMPIA) */
    * { box-sizing: border-box; user-select: none; }
    body { margin: 0; overflow: hidden; background: transparent; font-family: 'Segoe UI', system-ui, sans-serif; color: #eee; }
    #c { position: fixed; inset: 0; width: 100%; height: 100%; touch-action: none; z-index: 0; }

    .ui-panel {
      position: fixed; left: 20px; top: 20px; width: 340px; max-height: 95vh;
      background: rgba(10, 10, 14, 0.95); backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px;
      padding: 18px; overflow-y: auto; z-index: 100;
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
      transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      scrollbar-width: thin; scrollbar-color: #444 transparent;
    }
    .ui-panel.hidden { transform: translateX(-420px); }

    h2 { margin: 0 0 15px 0; font-size: 18px; color: #a29bfe; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
    .sec-head { font-size: 11px; font-weight: 700; color: #aaa; margin: 15px 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px; }

    .row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    label { font-size: 12px; flex: 1; color: #ccc; white-space: nowrap; font-weight: 500; }
    input[type=range] { flex: 2; height: 4px; background: #333; border-radius: 2px; accent-color: #6c5ce7; cursor: pointer; }
    .val { width: 40px; text-align: right; font-size: 11px; font-family: monospace; color: #a29bfe; }
    select, input[type=file] { width: 100%; background: #1e1e24; border: 1px solid #444; color: #eee; padding: 8px; border-radius: 8px; font-size: 11px; outline: none; }
    
    button { flex: 1; padding: 12px; border-radius: 8px; border: none; font-size: 12px; font-weight: 700; cursor: pointer; color: white; background: #333; transition: 0.2s; }
    button.primary { background: linear-gradient(135deg, #6c5ce7, #a29bfe); box-shadow: 0 4px 15px rgba(108,92,231,0.3); }
    button.danger { background: rgba(255, 71, 87, 0.15); border: 1px solid rgba(255, 71, 87, 0.3); color: #ff7675; }
    button.warn { background: rgba(253, 203, 110, 0.15); border: 1px solid rgba(253, 203, 110, 0.3); color: #ffeaa7; }

    .layer-list { max-height: 120px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 5px; margin-bottom: 10px; }
    .layer-item { padding: 10px; font-size: 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; border: 1px solid transparent; }
    .layer-item.active { background: rgba(108, 92, 231, 0.25); border-color: rgba(108, 92, 231, 0.5); color: white; }

    .toggle-ui { position: fixed; bottom: 25px; right: 25px; width: 50px; height: 50px; background: #1e1e24; border-radius: 50%; display: grid; place-items: center; font-size: 20px; border: 1px solid #555; z-index: 200; cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
    #vrBtn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 14px 45px; background: linear-gradient(135deg, #6c5ce7, #0984e3); color: white; border-radius: 50px; border: none; font-weight: 800; cursor: pointer; z-index: 1000; display: none; box-shadow: 0 0 30px rgba(108,92,231,0.6); animation: pulse 2s infinite; }
    @keyframes pulse { 0% {box-shadow: 0 0 20px rgba(108,92,231,0.6);} 50% {box-shadow: 0 0 40px rgba(108,92,231,0.8);} 100% {box-shadow: 0 0 20px rgba(108,92,231,0.6);} }
    
    .loader { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 5000; display: none; place-items: center; flex-direction: column; gap: 15px; color: #a29bfe; font-size: 14px; font-weight: bold; letter-spacing: 2px; }
    .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: #a29bfe; border-radius: 50%; animation: spin 1s infinite linear; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<canvas id="c"></canvas>
<div class="loader" id="loader"><div class="spinner"></div><span>CARGANDO...</span></div>

<div class="ui-panel" id="ui">
  <h2>ü•Ω MR Studio Diamond v4.0</h2>

  <div class="sec-head">üìÇ Archivos <button class="warn" style="padding:4px; font-size:10px; width:auto; flex:0;" onclick="fileInput.click()">+ IMPORTAR</button></div>
  <input type="file" id="fileInput" accept="image/*,video/*,.gif,.glb,.gltf,.fbx,.obj" multiple style="display:none;" />
  
  <div class="layer-list" id="layerList"></div>

  <div id="generalControls">
      <div class="sec-head">üìç Proyecci√≥n</div>
      <div class="row">
        <select id="projSelect">
          <option value="plane">Plano 2D</option>
          <option value="360">Esfera 360¬∞ (Inmersiva)</option>
          <option value="180">Domo 180¬∞ (Inmersiva)</option>
        </select>
      </div>
      <div class="row" id="shapeRow" style="display:none;">
        <label>Geometr√≠a</label>
        <select id="shapeSelect">
            <option value="sphere">Esfera (Est√°ndar)</option>
            <option value="cube">Cubo (Skybox)</option>
            <option value="ovoid">Ovoide (Vertical)</option>
        </select>
      </div>
      
      <div class="sec-head">üìè Transformaci√≥n</div>
      <div class="row">
        <label>Escala</label><input type="range" id="scale" min="0.1" max="10" step="0.05" value="1">
        <span class="val" id="v_scale">1.0</span>
      </div>
      <div class="row">
        <label>Modo Espejo (Flip H)</label>
        <input type="checkbox" id="checkFlip" style="flex:0; width:18px; height:18px;">
      </div>
      
      <div id="posControls">
        <div class="row"><label>Distancia</label><input type="range" id="dist" min="0" max="15" step="0.1" value="2"><span class="val" id="v_dist">2.0</span></div>
        <div class="row"><label>Altura</label><input type="range" id="height" min="-5" max="5" step="0.1" value="1.6"><span class="val" id="v_height">1.6</span></div>
      </div>
      <div class="row"><label>Rotaci√≥n Y</label><input type="range" id="rotY" min="0" max="360" step="1" value="0"><span class="val" id="v_rotY">0</span></div>
  </div>

  <div id="mediaControls" style="display:none;">
    
    <div class="sec-head">üé® Color & Imagen</div>
    <div class="row"><label>Brillo</label><input type="range" id="brightness" min="-1" max="1" step="0.05" value="0"><span class="val" id="v_brightness">0.0</span></div>
    <div class="row"><label>Contraste</label><input type="range" id="contrast" min="0" max="3" step="0.1" value="1"><span class="val" id="v_contrast">1.0</span></div>
    <div class="row"><label>Saturaci√≥n</label><input type="range" id="saturation" min="0" max="3" step="0.1" value="1"><span class="val" id="v_saturation">1.0</span></div>
    <div class="row"><label>Gamma</label><input type="range" id="gamma" min="0.1" max="3" step="0.1" value="1"><span class="val" id="v_gamma">1.0</span></div>

    <div class="sec-head">üñºÔ∏è Ajuste Visual</div>
    <div class="row"><label>Desfase X</label><input type="range" id="offsetX" min="-1" max="1" step="0.01" value="0"><span class="val" id="v_offsetX">0.0</span></div>
    <div class="row"><label>Desfase Y</label><input type="range" id="offsetY" min="-1" max="1" step="0.01" value="0"><span class="val" id="v_offsetY">0.0</span></div>

    <div class="sec-head">üü© Chroma Key Pro (Despill + Protect)</div>
    <div class="row">
      <label>Activar</label> <input type="checkbox" id="chromaActive" style="flex:0; width:18px; height:18px;">
      <label style="margin-left:15px">Invertir</label> <input type="checkbox" id="chromaInvert" style="flex:0; width:18px; height:18px;">
    </div>
    
    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin:8px 0; border:1px solid rgba(255,255,255,0.05);">
      <div class="row"><label style="color:#ff7675">Rojo</label><input type="range" id="keyR" min="0" max="1" step="0.01" value="0"><span class="val" id="v_keyR">0.0</span></div>
      <div class="row"><label style="color:#55efc4">Verde</label><input type="range" id="keyG" min="0" max="1" step="0.01" value="1"><span class="val" id="v_keyG">1.0</span></div>
      <div class="row"><label style="color:#74b9ff">Azul</label><input type="range" id="keyB" min="0" max="1" step="0.01" value="0"><span class="val" id="v_keyB">0.0</span></div>
      <div id="colorPrev" style="height:8px; width:100%; border-radius:4px; background:#0f0; margin-top:6px; transition:0.3s;"></div>
    </div>

    <div class="row"><label>Similitud</label><input type="range" id="sim" min="0" max="1" step="0.001" value="0.4"><span class="val" id="v_sim">0.4</span></div>
    <div class="row"><label>Suavizado</label><input type="range" id="smooth" min="0" max="0.5" step="0.001" value="0.05"><span class="val" id="v_smooth">0.05</span></div>
    <div class="row"><label>Opacidad</label><input type="range" id="opacity" min="0" max="1" step="0.05" value="1"><span class="val" id="v_opacity">1.0</span></div>
  </div>

  <div class="btn-group" style="margin-top:20px;">
    <button class="primary" onclick="centerActive()">üéØ Centrar</button>
    <button class="warn" onclick="reloadVideo()">üîÑ Recargar Video</button>
    <button class="danger" onclick="deleteActive()">üóëÔ∏è Borrar</button>
  </div>
  
  <div class="row" style="margin-top:20px; font-size:11px; color:#888; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
    <label><input type="checkbox" id="checkGizmo" checked> Gizmos</label>
    <label title="Requiere reiniciar sesi√≥n VR"><input type="checkbox" id="checkOcclusion" checked> Oclusi√≥n (Mundo Real)</label>
  </div>
</div>

<div class="toggle-ui" onclick="toggleUI()">üëÅÔ∏è</div>
<button id="vrBtn">ENTRAR EN MR</button>

<script type="importmap">
  { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/" } }
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';

let scene, camera, renderer, xrSession;
let objects = [];
let activeId = null;
let transformControl;

const ctrl = {
  right: { gripped: false, lastPos: new THREE.Vector3(), lastQuat: new THREE.Quaternion(), lastTrig: false, lastBtn: false },
  left: { gripped: false },
  gesture: { active: false, startDist: 0, startScale: 1 }
};
let rightRay, rayCursor, hoverId;

const vert = `
varying vec2 vUv; 
uniform vec2 offset; 
void main() { 
    vUv = uv + offset; 
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); 
}`;

// SHADER MEJORADO CON DESPILL PARA QUITAR HALOS GRISACEOS/AZULES
const frag = `
uniform sampler2D map;
uniform bool chromaEnabled, chromaInvert;
uniform vec3 keyColor;
uniform float similarity, smoothness, opacity;
uniform float brightness, contrast, saturation, gamma;

varying vec2 vUv;

vec3 rgb2hsv(vec3 c) {
    vec4 K = vec4(0.0, -1.0/3.0, 2.0/3.0, -1.0);
    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
    float d = q.x - min(q.w, q.y);
    float e = 1.0e-10;
    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
}

vec3 adjustColor(vec3 color) {
    color += brightness;
    color = (color - 0.5) * contrast + 0.5;
    float gray = dot(color, vec3(0.299, 0.587, 0.114));
    color = mix(vec3(gray), color, saturation);
    color = pow(max(color, 0.0), vec3(1.0 / gamma));
    return color;
}

void main() {
    vec4 tex = texture2D(map, vUv);
    vec3 col = tex.rgb;
    float alpha = tex.a * opacity;

    if (chromaEnabled) {
        vec3 hsv = rgb2hsv(col);
        vec3 kHsv = rgb2hsv(keyColor);
        
        float hueDist = abs(hsv.x - kHsv.x);
        if (hueDist > 0.5) hueDist = 1.0 - hueDist;
        float dist = sqrt(pow(hueDist * 2.0, 2.0) + pow(hsv.y - kHsv.y, 2.0)); 
        
        float mask = smoothstep(similarity, similarity + smoothness, dist);
        
        // --- PROTECCI√ìN FACIAL (Face Protect) ---
        float protection = 0.0;
        if(keyColor.g > keyColor.r && keyColor.g > keyColor.b) {
            protection = (col.r - col.g) * 3.0; 
        } else if(keyColor.b > keyColor.r && keyColor.b > keyColor.g) {
            protection = (col.r - col.b) * 3.0;
        }
        if(protection > 0.0) mask = clamp(mask + protection, 0.0, 1.0);

        if (!chromaInvert) {
            alpha *= mask;
            
            // --- DESPILL (ELIMINAR HALO AZUL/GRIS) ---
            // Si el pixel es semitransparente o cercano al color clave,
            // neutralizamos el componente de color dominante.
            if(mask < 0.98) {
               float spillVal = 0.0;
               if (keyColor.g > keyColor.r && keyColor.g > keyColor.b) {
                   // Green Screen: reemplazar verde con el promedio de R y B
                   spillVal = (col.r + col.b) * 0.5;
                   if(col.g > spillVal) col.g = mix(col.g, spillVal, 0.8 * (1.0-mask));
               } else if (keyColor.b > keyColor.g && keyColor.b > keyColor.r) {
                   // Blue Screen: reemplazar azul con el promedio de R y G
                   spillVal = (col.r + col.g) * 0.5;
                   if(col.b > spillVal) col.b = mix(col.b, spillVal, 0.8 * (1.0-mask));
               }
            }
            
        } else {
            alpha *= (1.0 - mask);
        }
    }
    
    col = adjustColor(col);
    gl_FragColor = vec4(col, alpha);
    if (alpha < 0.01) discard; 
}
`;

function init() {
  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('c'), alpha: true, antialias: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  renderer.xr.setReferenceSpaceType('local-floor');

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 2000);
  
  scene.add(new THREE.AmbientLight(0xffffff, 1.2));
  const d = new THREE.DirectionalLight(0xffffff, 1.5); d.position.set(2, 5, 2); scene.add(d);

  transformControl = new TransformControls(camera, renderer.domElement);
  transformControl.addEventListener('dragging-changed', e=>{}); 
  scene.add(transformControl);

  setupVR(); initRay();
  window.addEventListener('resize', onResize);
  renderer.setAnimationLoop(render);
}

function onResize() {
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

document.getElementById('fileInput').addEventListener('change', async e => {
  if(!e.target.files.length) return;
  toggleLoader(true);
  for(const f of e.target.files) {
    try {
      const url = URL.createObjectURL(f);
      const n = f.name.toLowerCase();
      if(n.match(/\.(glb|gltf)$/)) await load3D(url, n, 'gltf');
      else if(n.match(/\.fbx$/)) await load3D(url, n, 'fbx');
      else if(n.match(/\.obj$/)) await load3D(url, n, 'obj');
      else if(n.match(/\.gif$/)) await loadGif(f, n);
      else if(f.type.startsWith('video/') || n.includes('360')) await loadVideo(url, n);
      else if(f.type.startsWith('image/')) await loadImg(url, n);
    } catch(err) { 
      console.error('Error al cargar archivo:', f.name, err); 
    }
  }
  toggleLoader(false);
  e.target.value = '';
});

async function loadVideo(url, name) {
  const vid = document.createElement('video');
  vid.src = url; vid.crossOrigin = 'anonymous'; 
  vid.loop = true; vid.muted = true; vid.playsInline = true;
  vid.style.display = 'none'; document.body.appendChild(vid);

  await new Promise(resolve => {
     vid.onloadedmetadata = () => { resolve(); };
     vid.play().catch(e=>console.log("Autoplay prevent:", e));
  });

  const tex = new THREE.VideoTexture(vid);
  tex.colorSpace = THREE.SRGBColorSpace;
  tex.wrapS = THREE.RepeatWrapping; tex.wrapT = THREE.RepeatWrapping;
  tex.minFilter = THREE.LinearFilter; tex.magFilter = THREE.LinearFilter;
  
  let proj = 'plane';
  if(name.includes('360')) proj='360';
  else if(name.includes('180')) proj='180';

  const ar = (vid.videoWidth && vid.videoHeight) ? vid.videoWidth/vid.videoHeight : 1.77;

  // Creamos con forma 'sphere' por defecto
  const mesh = createMesh(proj, 'sphere', tex, ar);
  const obj = { id: uid(), mesh, name, type:'video', video:vid, tex, settings: defSettings() };
  obj.settings.projection = proj;
  
  if(proj !== 'plane') {
      obj.mesh.position.set(0, 1.6, 0); // Posici√≥n inicial
      obj.settings.scale = 1; 
      obj.settings.dist = 0;
  } else {
      obj.mesh.position.set(0, 1.6, -2);
      obj.settings.dist = 2;
  }

  addObj(obj);
}

async function loadGif(file, name) {
  const buf = await file.arrayBuffer();
  // @ts-ignore
  let R = window.GifReader || (window.Omggif ? window.Omggif.GifReader : null);
  if(!R) return;
  const r = new R(new Uint8Array(buf));
  const w=r.width, h=r.height;
  const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
  const ctx=cvs.getContext('2d'); const dat=ctx.createImageData(w,h);
  const tex=new THREE.CanvasTexture(cvs); tex.colorSpace=THREE.SRGBColorSpace;
  tex.wrapS = THREE.RepeatWrapping; tex.wrapT = THREE.RepeatWrapping;
  
  const mesh = createMesh('plane', 'sphere', tex, w/h);
  mesh.position.set(0, 1.6, -2);
  const obj = { id:uid(), mesh, name, type:'gif', settings:defSettings(), gif:{r,ctx,dat,tex,f:0,num:r.numFrames(),t:0} };
  addObj(obj);
}

async function loadImg(url, name) {
  const tex = await new THREE.TextureLoader().loadAsync(url);
  tex.colorSpace = THREE.SRGBColorSpace;
  tex.wrapS = THREE.RepeatWrapping; tex.wrapT = THREE.Repeat
